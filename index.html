<!DOCTYPE html>
<html>
<head>
  <title>TechZone.sv - Panel de Admin</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 20px;
    }
    #qr-reader {
      width: 300px;
      margin: 0 auto;
    }
    .admin-container {
      text-align: center;
    }
    .button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s ease;
    }
    .button:hover {
      background: #2980b9;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <h1>Panel de Administración</h1>
    <p>Escanea el QR del cliente para registrar una compra:</p>
    <!-- Contenedor para el escáner -->
    <div id="qr-reader"></div>
    <div id="qr-reader-results"></div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  
  <!-- html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
  // Initialize Firebase (usa la misma config que tu proyecto)
  const firebaseConfig = {
    apiKey: "AIzaSyBV7aFTNp8BNZoT-3kJvOWhrR5fA_mrUos",
    authDomain: "techcard-ac30e.firebaseapp.com",
    projectId: "techcard-ac30e",
    storageBucket: "techcard-ac30e.firebasestorage.app",
    messagingSenderId: "193812816787",
    appId: "1:193812816787:web:4096953d9ec882fed03e66"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  // Aquí podrías agregar un login de administrador, si así lo deseas.
  // Por simplicidad, asumimos que ya estás autenticado como admin.
  
  // Función para añadir sello y cashback a un usuario por su UID:
  async function addStampAndCashbackToUser(uid, purchaseAmount) {
    try {
      const userRef = db.collection('users').doc(uid);
      const userDoc = await userRef.get();

      if (!userDoc.exists) {
        alert("El usuario con UID " + uid + " no existe.");
        return;
      }

      const userData = userDoc.data();
      let totalStamps = userData.stamps || 0;
      let totalCashback = userData.cashback || 0;
      let currentDiscount = userData.currentDiscount || 0;

      // Añadimos un sello si no tiene 10 aún
      if (totalStamps < 10) {
        totalStamps++;
      }

      // Añadimos cashback
      const cashback = purchaseAmount * 0.05;
      totalCashback += cashback;

      // Si llega a 10 sellos y no tenía un descuento en curso, generamos uno
      if (totalStamps === 10 && currentDiscount === 0) {
        currentDiscount = getRandomDiscount();
        alert("¡El usuario ha obtenido un descuento del " + currentDiscount + "%!");
      }

      // Guardamos en Firestore
      await userRef.update({
        stamps: totalStamps,
        cashback: totalCashback,
        currentDiscount: currentDiscount
      });

      alert("Compra registrada. Nuevo total de sellos: " + totalStamps +
            ". Cashback acumulado: $" + totalCashback.toFixed(2));
    } catch (error) {
      alert("Error al actualizar al usuario: " + error.message);
    }
  }

  // Copiamos la función de descuento aleatorio:
  function getRandomDiscount() {
    const rand = Math.random() * 100;
    if (rand < 50) return 10;     // 50% probabilidad
    if (rand < 80) return 15;     // 30% probabilidad
    if (rand < 95) return 25;     // 15% probabilidad
    return 50;                    // 5% probabilidad
  }

  // Inicializamos el lector de QR
  document.addEventListener('DOMContentLoaded', () => {
    const html5QrCode = new Html5Qrcode("qr-reader");

    function onScanSuccess(decodedText, decodedResult) {
      // Suponemos que el QR contiene directamente el UID del usuario
      // Ej: "kHs83M9QW9cnHjXYZ..."
      const uid = decodedText.trim();
      html5QrCode.stop(); // Detener la cámara

      // Pedimos el monto de la compra
      const purchaseAmount = parseFloat(prompt("Escaneado UID: " + uid + 
        "\nIngresa el monto de la compra:"));
      if (!isNaN(purchaseAmount) && purchaseAmount > 0) {
        addStampAndCashbackToUser(uid, purchaseAmount);
      } else {
        alert("Monto no válido. Operación cancelada.");
      }
    }

    function onScanFailure(error) {
      // Puedes manejar los errores de lectura aquí (si lo deseas)
    }

    // Iniciamos la cámara (si el usuario da permiso)
    Html5Qrcode.getCameras().then((devices) => {
      if (devices && devices.length) {
        // Escoger la primera cámara
        var cameraId = devices[0].id;
        html5QrCode.start(
          cameraId,
          {
            fps: 10,    // frames por segundo
            qrbox: 250  // tamaño del recuadro de QR
          },
          onScanSuccess,
          onScanFailure
        );
      }
    }).catch((err) => {
      alert("No se pudo acceder a la cámara: " + err);
    });
  });
  </script>
</body>
</html>
