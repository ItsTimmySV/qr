<!DOCTYPE html>
<html>
<head>
  <title>TechZone.sv - Panel de Administración</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 20px;
      text-align: center;
    }
    #admin-auth-container,
    #admin-content {
      max-width: 500px;
      margin: 0 auto;
    }
    #admin-auth-container h2 {
      margin-bottom: 10px;
    }
    #adminLoginForm input {
      display: block;
      margin: 10px auto;
      padding: 8px;
      width: 80%;
      max-width: 300px;
    }
    #adminLoginForm button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    #adminLoginForm button:hover {
      background: #2980b9;
    }

    /* Ocultamos el panel de admin por defecto */
    #admin-content {
      display: none;
    }

    /* Ajustamos el contenedor del lector para pantallas grandes */
    #qr-reader {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      margin-top: 20px;
    }

    /* Media query para pantallas pequeñas (ej: celular) */
    @media (max-width: 600px) {
      #qr-reader {
        width: 90vw;  /* Ocupará 90% del ancho de la pantalla */
        max-width: none; /* Quitar límite de 500px */
        margin-top: 10px;
      }
    }

    .button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.3s ease;
    }
    .button:hover {
      background: #2980b9;
    }
  </style>
</head>
<body>

  <!-- Contenedor para login de administrador -->
  <div id="admin-auth-container">
    <h2>Administrador - Iniciar Sesión</h2>
    <form id="adminLoginForm">
      <input type="email" id="adminEmail" placeholder="Correo de administrador" required>
      <input type="password" id="adminPassword" placeholder="Contraseña" required>
      <button type="submit">Ingresar</button>
    </form>
  </div>

  <!-- Panel de administración (se mostrará tras login) -->
  <div id="admin-content">
    <h1>Panel de Administración</h1>
    <p>Escanea el QR del cliente para registrar una compra:</p>
    <div id="qr-reader"></div>
    <div id="qr-reader-results"></div>
    <button id="logoutBtn" class="button">Cerrar Sesión</button>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  
  <!-- html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
  // =======================
  //   Configuración Firebase
  // =======================
  const firebaseConfig = {
    apiKey: "AIzaSyBV7aFTNp8BNZoT-3kJvOWhrR5fA_mrUos",
    authDomain: "techcard-ac30e.firebaseapp.com",
    projectId: "techcard-ac30e",
    storageBucket: "techcard-ac30e.firebasestorage.app",
    messagingSenderId: "193812816787",
    appId: "1:193812816787:web:4096953d9ec882fed03e66"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  // =========================
  //   Variables DOM
  // =========================
  const adminAuthContainer = document.getElementById('admin-auth-container');
  const adminLoginForm = document.getElementById('adminLoginForm');
  const adminContent = document.getElementById('admin-content');
  const logoutBtn = document.getElementById('logoutBtn');

  // Globales para el lector
  let html5QrCode = null;
  let selectedCameraId = null; // Guardaremos la cámara trasera si existe

  // =========================
  //   Inicio de sesión Admin
  // =========================
  adminLoginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('adminEmail').value;
    const password = document.getElementById('adminPassword').value;

    try {
      await auth.signInWithEmailAndPassword(email, password);
      // Si se loguea bien, onAuthStateChanged se encargará de mostrar el panel.
    } catch (error) {
      alert("Error al iniciar sesión: " + error.message);
    }
  });

  // =========================
  //   Observador de Auth
  // =========================
  auth.onAuthStateChanged((user) => {
    if (user) {
      // Muestra panel de admin
      adminAuthContainer.style.display = 'none';
      adminContent.style.display = 'block';

      // Iniciamos la cámara (si no la hemos iniciado)
      startQrScanner();
    } else {
      // No está logueado
      adminAuthContainer.style.display = 'block';
      adminContent.style.display = 'none';
    }
  });

  // =========================
  //    Logout
  // =========================
  logoutBtn.addEventListener('click', async () => {
    if (html5QrCode) {
      // Detenemos la cámara antes de cerrar sesión
      await html5QrCode.stop().catch(err => console.warn(err));
      html5QrCode = null;
    }
    await auth.signOut();
  });

  // =========================
  //  Funciones para registrar compra
  // =========================
  async function addStampAndCashbackToUser(uid, purchaseAmount) {
    try {
      const userRef = db.collection('users').doc(uid);
      const userDoc = await userRef.get();

      if (!userDoc.exists) {
        alert("El usuario con UID '" + uid + "' no existe en la base de datos.");
        return;
      }

      const userData = userDoc.data();
      let totalStamps = userData.stamps || 0;
      let totalCashback = userData.cashback || 0;
      let currentDiscount = userData.currentDiscount || 0;

      // Añadimos un sello si no tiene 10 aún
      if (totalStamps < 10) {
        totalStamps++;
      }

      // Añadimos cashback
      const cashback = purchaseAmount * 0.05;
      totalCashback += cashback;

      // Si llega a 10 sellos y no tenía un descuento en curso, generamos uno
      if (totalStamps === 10 && currentDiscount === 0) {
        currentDiscount = getRandomDiscount();
        alert("¡El usuario ha obtenido un descuento del " + currentDiscount + "%!");
      }

      // Guardamos en Firestore
      await userRef.update({
        stamps: totalStamps,
        cashback: totalCashback,
        currentDiscount: currentDiscount
      });

      alert(
        "Compra registrada.\n" +
        "Sello(s): " + totalStamps +
        "\nCashback acumulado: $" + totalCashback.toFixed(2)
      );
    } catch (error) {
      alert("Error al actualizar al usuario: " + error.message);
    }
  }

  function getRandomDiscount() {
    const rand = Math.random() * 100;
    if (rand < 50) return 10;    // 50% probabilidad
    if (rand < 80) return 15;    // 30% probabilidad
    if (rand < 95) return 25;    // 15% probabilidad
    return 50;                   // 5% probabilidad
  }

  // =========================
  //      Lector de QR
  // =========================
  function startQrScanner() {
    // Si ya tenemos html5QrCode inicializado, no hacemos nada
    if (html5QrCode) return;

    html5QrCode = new Html5Qrcode("qr-reader");

    function onScanSuccess(decodedText, decodedResult) {
      // UID del usuario
      const uid = decodedText.trim();
      // Detenemos la cámara temporalmente
      html5QrCode.stop()
      .then(() => {
        // Pedimos el monto de la compra
        const purchaseAmount = parseFloat(prompt(
          "UID escaneado: " + uid + "\nIngresa el monto de la compra:"
        ));
        if (!isNaN(purchaseAmount) && purchaseAmount > 0) {
          addStampAndCashbackToUser(uid, purchaseAmount);
        } else {
          alert("Monto no válido. Operación cancelada.");
        }
      })
      .catch((err) => {
        console.warn("Error al parar la cámara:", err);
      })
      .finally(() => {
        // Iniciamos de nuevo la cámara para el siguiente scan
        restartScanner();
      });
    }

    function onScanFailure(error) {
      // Errores de lectura (normal si no detecta un QR). Ocurre en cada frame sin QR válido
      // console.warn("Escaneo falló: ", error);
    }

    Html5Qrcode.getCameras().then((devices) => {
      if (devices && devices.length) {
        // Intentamos forzar la cámara trasera
        selectedCameraId = devices[0].id;
        for (let i = 0; i < devices.length; i++) {
          const label = devices[i].label.toLowerCase();
          if (label.includes('back') || label.includes('rear')) {
            selectedCameraId = devices[i].id;
            break;
          }
        }

        // Iniciamos el escáner
        html5QrCode
          .start(
            selectedCameraId,
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
          )
          .catch((err) => {
            alert("No se pudo acceder a la cámara: " + err);
          });
      } else {
        alert("No se encontró ninguna cámara disponible.");
      }
    })
    .catch((err) => {
      alert("No se pudo acceder a la cámara: " + err);
    });
  }

  // Función para reiniciar la cámara después de registrar la compra
  function restartScanner() {
    if (!html5QrCode || !selectedCameraId) return;
    html5QrCode.start(
      selectedCameraId,
      { fps: 10, qrbox: 250 },
      (decodedText, decodedResult) => onScanSuccess(decodedText, decodedResult),
      (error) => onScanFailure(error)
    )
    .catch((err) => {
      console.error("Error al reiniciar el escáner:", err);
    });
  }

  // Copiamos las funciones onScanSuccess y onScanFailure fuera para poder llamarlas en restartScanner
  function onScanSuccess(decodedText, decodedResult) {
    const uid = decodedText.trim();
    html5QrCode.stop()
    .then(() => {
      const purchaseAmount = parseFloat(prompt(
        "UID escaneado: " + uid + "\nIngresa el monto de la compra:"
      ));
      if (!isNaN(purchaseAmount) && purchaseAmount > 0) {
        addStampAndCashbackToUser(uid, purchaseAmount);
      } else {
        alert("Monto no válido. Operación cancelada.");
      }
    })
    .catch((err) => {
      console.warn("Error al parar la cámara:", err);
    })
    .finally(() => {
      restartScanner();
    });
  }

  function onScanFailure(error) {
    // Se llama repetidamente si no hay QR o es ilegible
  }
  </script>
</body>
</html>
